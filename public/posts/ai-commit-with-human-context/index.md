---
title: "AIによるコミット自動化（改善版）"
date: "2025-11-28"
description: "以前公開した「AIによるコミット自動化」の記事に対して、AIに丸投げするのは危険で、Whyの部分は人間が考えるべきというフィードバックを頂きました。そのフィードバックを反映し、AIはコミットの粒度を判断してステージングし、質問することで人間からWhyを引き出す形式に改善したSlash Commandを作成しました。"
---

## 背景・モチベーション

以前公開した「[AI によるコミット自動化](/posts/ai-commit-automation)」の記事に対して、以下のようなフィードバックを頂きました。

- AI に丸投げするのは危険
- AI はまだ Why の部分を察するのが下手くそだから人間がコンテキスト入れないとだめ

確かに、AI はコードの差分から「何をしたか」は理解できますが、「なぜその変更をしたか」という背景や文脈は、セッション情報があっても完全には理解できないことがあります。特に、ビジネス要件や設計判断、過去の議論の経緯などは、コードの差分だけからは読み取れません。

そこで、以下のように方針を変更しました。

- AI にコミットの粒度を考えさせるのは同じ（これは AI が得意）
- でもその変更の Why の部分は人間が考える（これは人間が知っている情報）
- AI が質問することで、人間から Why を引き出す

これにより、AI の力を活用しつつ、人間が持つ文脈情報をコミットメッセージに反映できるようになります。

## 作成した Slash Command

````md:commit.md
---
description: Git差分を分析して適切な粒度でコミットを作成（AIが質問してWhyを引き出す）
---

## 実行手順

1. `git status` と `git diff` で変更を分析
2. 差分に潜在的な問題や懸念事項があれば報告し、コミットしない
3. 以下の基準でコミットをグループ化:
   - 1 コミット = 1 論理変更
   - 依存する変更は同一コミット
4. 適切な粒度で変更をステージングする（`git add`）
5. ステージングした変更について、Why（変更の理由）を理解するために質問を生成し、ユーザーに質問する
   - ステージングした変更（diff）とセッション情報の両方を分析すること
   - まず、ステージングした変更とセッション情報を分析し、既に利用可能なコンテキストを理解する
   - セッション情報から読み取れない「Why」についてのみ質問する
   - セッション情報から「Why」を理解できる場合は、質問せずにコミットメッセージを生成する
   - 質問が必要な場合のみ、必要な質問を一度に生成する（質問数は変更の複雑さとセッション情報に含まれるコンテキストの量によって異なる）
   - 全ての質問を一度にユーザーに提示する
   - 「何をしたか」ではなく、「なぜ」「意図」に焦点を当てる
   - 「この変更は何をしますか？」のような汎用的な質問は避ける
   - 良い質問の例（diffで特定の変更を見た場合）:
     - タイムアウト値の変更を見た場合: 「タイムアウトを3秒から5秒に増やした理由はなんですか？」
     - nilチェックの追加を見た場合: 「このnilチェックはどのエッジケースやエラーシナリオに対応していますか？」
     - コードのリファクタリングを見た場合: 「このリファクタリングはより大きなクリーンアップの一部ですか？それとも特定の問題があって行ったものですか？」
     - テストの分割を見た場合: 「このテストを複数の小さなテストに分割した理由はなんですか？」
   - 悪い質問の例（避けるべき）:
     - 「ファイルを更新しましたか？」（diffから明らか）
     - 「Xの新しい値は何ですか？」（diffで確認できる）
     - 「この変更は何をしますか？」（汎用的すぎる、「なぜ」に焦点を当てる）
6. 質問をした場合、ユーザーから全ての質問への回答を集める
7. 質問への回答（およびセッション情報）を基にコミットメッセージを完成させる
8. 必ずユーザーの確認を取ってからコミットを実行する
9. ユーザーが確認したら、コミットを実行する
10. ステージングされていない変更が残っている場合は、4 に戻る

## コミットメッセージ形式

```
<emoji> <prefix>: <subject>

[body: 変更の理由を説明（質問への回答を基に生成）]
```

**<emoji> <prefix> 一覧:**

- ✨ feat: 新機能の追加
- 🐛 fix: バグ修正
- ⚡️ perf: パフォーマンス改善
- ♻️ refactor: コードのリファクタリング
- 🔥 remove: コードやファイルの削除
- 💄 style: UI やスタイルファイルの追加・更新
- 🚸 ux: ユーザー体験/ユーザビリティの改善
- ♿️ a11y: アクセシビリティの改善
- 📝 docs: ドキュメントの追加・更新
- 💡 comment: ソースコード内のコメント追加・更新
- ✏️ typo: タイポの修正
- 🤡 mock: モックの作成
- 🏷️ types: 型の追加・更新

**ルール:**

- subject: 50 文字以内で変更内容を簡潔に説明（AIが生成）
- body: 変更の理由("なぜ")を詳しく説明（質問への回答およびセッション情報を基にAIが生成）。diffの内容を説明するのではなく、物語性とコンテキストに焦点を当てる。シグナル:ノイズ比を考える - 読者が変更の「なぜ」を真に理解できるようにする
- bodyの各文は一行ずつ記述すること（一文一行）
- 必ずユーザーの確認を取ってからコミットを実行すること
- このコマンド実行後は通常モードに戻り、ユーザーが明示的に `/commit` を実行するまで自動的にコミットしない
- コミットメッセージは全て日本語で記述してください。
````

## 解説

### 実行手順の変更

**旧版:**

- コミット計画を表形式で提示し、確認なしで直接実行

**改善版:**

- 適切な粒度で変更をステージングする（`git add`）
- ステージングした変更とセッション情報の両方を分析し、セッション情報から読み取れない「Why」についてのみ質問を生成
- 全ての質問を一度にユーザーに提示
- 質問への回答を集めてコミットメッセージを生成
- **必ずユーザーの確認を取ってからコミットを実行**

### セッション情報から読み取れない Why だけを質問する

この改善版の最大の特徴は、**AI がセッション情報を分析し、読み取れない Why についてのみ質問することで人間から情報を引き出す**ことです。

AI はコードの差分から「何をしたか」は理解できますが、「なぜその変更をしたか」という背景や文脈は、コードの差分だけからは読み取れません。しかし、セッション情報には既に多くのコンテキストが含まれている場合があります。そのため、AI はまずセッション情報を分析し、読み取れない Why についてのみ質問することで、効率的に必要な情報を引き出し、より正確で有用なコミットメッセージを作成できます。

### 質問を一度に生成し、全てまとめて提示する

旧版では質問の生成方法についての記述がありませんでしたが、改善版では以下のように変更しました。

- ステージングした変更を分析して、Why を理解するために必要な質問を一度に生成
- 質問数は変更の複雑さとセッション情報に含まれるコンテキストの量によって異なる（通常 2-4 問程度）
- 生成した全ての質問を一度にユーザーに提示

これにより、ユーザーは質問の全体像を把握しやすくなり、効率的に回答できます。

### 必ずユーザーの確認を取ってから実行

旧版では「ユーザーの確認を求めずに直接実行」していましたが、改善版では「必ずユーザーの確認を取ってからコミットを実行する」ように変更しました。

これにより、ユーザーは生成されたコミットメッセージを確認し、必要に応じて修正や改善を依頼できます。

### body の生成方法の変更

**旧版:**

- body: 変更の理由("なぜ")を詳しく説明

**改善版:**

- body: 変更の理由("なぜ")を詳しく説明（質問への回答およびセッション情報を基に AI が生成）
- diff の内容を説明するのではなく、物語性とコンテキストに焦点を当てる
- シグナル:ノイズ比を考える - 読者が変更の「なぜ」を真に理解できるようにする
- **body の各文は一行ずつ記述すること（一文一行）**

この Slash Command では、AI が質問することで人間から Why を引き出し、それを基にコミットメッセージを生成することで、より正確で有用なコミットメッセージになります。

## 終わりに

AI にコミットメッセージを完全に任せるのではなく、AI と人間が協力することで、より正確で有用なコミットメッセージを作成できるようになりました。AI はコミットの粒度を判断し、セッション情報を分析して読み取れない Why についてのみ質問することで人間から情報を引き出す。この役割分担により、AI の力を活用しつつ、人間が持つ文脈情報をコミットメッセージに反映できます。

## 参考

- [AI によるコミット自動化（前回の記事）](/posts/ai-commit-automation)
- https://code.claude.com/docs/ja/slash-commands
